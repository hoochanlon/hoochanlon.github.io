---
import { encrypt } from "@/utils/encrypt";

export interface Props {
  password: string;
}

const html = await Astro.slots.render("default");
const encryptedHtml = await encrypt(html, Astro.props.password);
---

<meta name="encrypted" content={encryptedHtml} />

<div>
  <input
    id="password"
    class="border-skin-fill border-opacity-40 bg-skin-fill text-skin-base placeholder:text-opacity-75 focus:border-skin-accent w-auto rounded border p-2 placeholder:italic focus:outline-none"
    placeholder="请输入密码"
    type="text"
    autocomplete="off"
    autofocus
  />
  <button
    id="password-btn"
    class="bg-skin-full border-skin-fill border-opacity-50 text-skin-base hover:border-skin-accent rounded-md border p-2"
  >
    确认
  </button>
  <!-- 错误提示元素 -->
  <div id="error-message" class="text-red-600 hidden">
    密码错误，请重新输入。
  </div>
</div>

<script is:inline data-astro-rerun>
  /**
   * 异步解密函数
   *
   * @param data Base64 加密字符串
   * @param key 密码
   *
   * @returns 解密后的明文字符串
   */
  async function decrypt(data, key) {
    key = key.padEnd(16, "0"); // AES-CBC key 补齐 16 字节
    const dataBuffer = new Uint8Array(
      atob(data)
        .split("")
        .map(c => c.charCodeAt(0))
    );
    const keyBuffer = new TextEncoder().encode(key);
    const cryptoKey = await crypto.subtle.importKey(
      "raw",
      keyBuffer,
      { name: "AES-CBC", length: 256 },
      false,
      ["decrypt"]
    );
    const iv = dataBuffer.slice(0, 16);
    const encryptedData = dataBuffer.slice(16);
    const decryptedData = await crypto.subtle.decrypt(
      { name: "AES-CBC", iv },
      cryptoKey,
      encryptedData
    );
    return new TextDecoder().decode(new Uint8Array(decryptedData));
  }

  /**
   * 初始化页面解密逻辑
   */
  function prepare() {
    const encrypted = document
      .querySelector("meta[name=encrypted]")?.getAttribute("content");
    const input = document.getElementById("password");
    const btn = document.getElementById("password-btn");
    const article = document.querySelector("#encryption");
    const key = window.location.pathname;
    const errorMessage = document.getElementById("error-message");

    btn?.addEventListener("click", async () => {
      const password = input.value;
      try {
        const html = await decrypt(encrypted, password);
        article.innerHTML = html;
        setItemWithExpire(key, password, 86400);
      } catch {
        if (errorMessage) {
          errorMessage.classList.remove("hidden"); // 显示错误消息
        }
      }
    });

    const savedPassword = getItemWithExpire(key);
    if (savedPassword) {
      input.value = savedPassword;
      btn?.click();
    }
  }

  function setItemWithExpire(key, value, ttl) {
    const item = { value: value, expire: new Date().getTime() + ttl * 1000 };
    localStorage.setItem(key, JSON.stringify(item));
  }

  function getItemWithExpire(key) {
    const itemStr = localStorage.getItem(key);
    if (!itemStr) return null;

    const item = JSON.parse(itemStr);
    if (new Date().getTime() > item.expire) {
      localStorage.removeItem(key);
      return null;
    }
    return item.value;
  }

  prepare();

  document.addEventListener("astro:after-swap", prepare);
</script>
