// ============================================================
// Butterfly æ— ç™½å±åŠ è½½åŠ¨ç”»å¢žå¼ºç‰ˆ âœ… (PJAX + Hash + CSSå…ˆæ˜¾ç¤º)
// ============================================================

if theme.preloader && theme.preloader.enable
  #loading-box
    .loading-bg
      img.loading-img(
        class='nolazyload',
        src=loading_img ? url_for(loading_img) : "/img/avatar.png"
      )
      .loading-image-dot

script.
  (function() {
    const mode = "!{theme.preloader.mode || 'exclude'}";
    const pages = !{JSON.stringify(theme.preloader.pages || [])};
    const path = window.location.pathname;
    const box = document.getElementById("loading-box");

    let showLoading = true;
    if (mode === "exclude") {
      showLoading = !pages.some(p => p === "HOME" ? path === "/" : path.startsWith(p));
    } else if (mode === "include") {
      showLoading = pages.some(p => p === "HOME" ? path === "/" : path.startsWith(p));
    }

    if (!showLoading) {
      if (box) box.classList.add("loaded");
      return;
    }

    const preloader = {
      _start: 0,
      show() {
        if (!box) return;
        // ðŸš€ ç¡®ä¿ç«‹åˆ»å¯è§
        box.classList.remove("loaded");
        box.style.display = "flex";
        box.style.opacity = "1";
        box.style.visibility = "visible";
        document.body.style.overflow = "hidden";
        preloader._start = Date.now();
      },
      hide(delay = 0) {
        if (!box) return;
        const elapsed = Date.now() - (preloader._start || 0);
        const minDelay = 600;
        const remain = Math.max(minDelay - elapsed, 0);
        setTimeout(() => {
          box.classList.add("loaded");
          document.body.style.overflow = "auto";
          if (window.WOW) new WOW().init();
        }, remain + delay);
      }
    };

    // åˆå§‹é¡µé¢æ˜¾ç¤º
    preloader._start = Date.now();

    document.addEventListener("DOMContentLoaded", () => preloader.hide());

    // === âœ… PJAX åŠ è½½åŠ¨ç”»å¢žå¼ºé€»è¾‘ ===
    document.addEventListener("pjax:send", () => {
      if (!box) return;
      // âš¡ï¸ é˜²æ­¢ç«žæ€ï¼šåœ¨æ¸…ç©ºæ—§ DOM å‰ç«‹å³æ˜¾ç¤º
      requestAnimationFrame(() => {
        preloader.show();
      });
    }, true);

    document.addEventListener("pjax:complete", () => {
      // âš¡ï¸ å»¶è¿Ÿéšè—ï¼Œé˜²æ­¢å†…å®¹å°šæœªå®Œå…¨æ¸²æŸ“
      setTimeout(() => preloader.hide(150), 150);
    }, true);

    // === Hash è·³è½¬ ===
    window.addEventListener("hashchange", () => {
      if (!box) return;
      preloader.show();
      setTimeout(() => preloader.hide(200), 300);
    });
  })();

