// ============================================================
// Butterfly ä¸»é¢˜å¯¼èˆªæ  nav.pug
// æ”¯æŒåŠ¨æ€è¿”å›žåˆ†ç±» / æ ‡ç­¾ / å½’æ¡£ / é¦–é¡µåˆ†é¡µæ¥æº
// ============================================================

nav#nav
  span#blog-info
    // ========================
    // éžæ–‡ç« é¡µï¼šæ˜¾ç¤ºç«™ç‚¹æ ‡é¢˜
    // ========================
    if globalPageType !== 'post'
      a.nav-site-title(href=url_for('/'))
        if theme.nav.logo
          img.site-icon(src=url_for(theme.nav.logo) alt='Logo')
        if theme.nav.display_title
          span.site-name=config.title

    // ========================
    // æ–‡ç« é¡µï¼šæ˜¾ç¤ºæ–‡ç« æ ‡é¢˜ä¸Žè¿”å›žæŒ‰é’®
    // ========================
    if globalPageType === 'post' && theme.nav.display_post_title
      // åˆå§‹ä¸ºä¸»é¡µé“¾æŽ¥ï¼Œç¨åŽ JS åŠ¨æ€ä¿®æ”¹ä¸ºæ¥æºè·¯å¾„
      a.nav-page-title#nav-back(href=url_for('/'))
        span.site-name= page.title || config.title
        span.site-name
          i.fa-solid.fa-circle-arrow-left
          // é»˜è®¤æ˜¾ç¤ºâ€œè¿”å›žé¦–é¡µâ€ï¼ŒJS åŠ¨æ€åˆ‡æ¢
          span#nav-back-text= ' ' + _p('post.back_to_home')

  // ========================
  // èœå•åŒºåŸŸ
  // ========================
  #menus
    if theme.menu
      != partial('includes/header/menu_item', {}, {cache: true})
      #toggle-menu
        span.site-page
          i.fas.fa-bars.fa-fw

  // ========================
  // æœç´¢æŒ‰é’®
  // ========================
  if theme.search.use
    #search-button
      span.site-page.social-icon.search
        i.fas.fa-search.fa-fw
        //- span= ' ' + _p('search.title')


// ============================================================
// âœ… JS åŠ¨æ€åˆ¤æ–­æ¥æºï¼šåˆ†é¡µ / åˆ†ç±» / æ ‡ç­¾ / å½’æ¡£ â†’ è¿”å›žæ‰€åœ¨é¡µï¼Œå¦åˆ™è¿”å›žé¦–é¡µ
// ============================================================
script.
  (function() {
    var backLink = document.getElementById('nav-back');
    var backText = document.getElementById('nav-back-text');
    if (!backLink || !backText) return;

    // è¯»å– URL å‚æ•°
    var params = new URLSearchParams(window.location.search);
    var from = params.get('from');     // æ¥æºè·¯å¾„ï¼Œå¦‚ categories/è€ƒè¯•ã€tags/ç¬”è®°ã€archivesã€page
    var pageNum = params.get('page');  // å½“å‰é¡µç ï¼ˆæ•°å­—ï¼‰

    if (from) {
      // âœ… ç¡®ä¿è·¯å¾„ç»“å°¾å¸¦æ–œæ 
      var base = from.replace(/\/?$/, '/');
      var href = '/'; // é»˜è®¤è¿”å›žé¦–é¡µ

      if (pageNum && /^\d+$/.test(pageNum)) {
        // æœ‰é¡µç æ—¶è¿”å›žå¯¹åº”åˆ†é¡µ
        href = (pageNum === '1')
          ? '/' + base
          : '/' + base + 'page/' + pageNum + '/#content-inner';
      } else {
        // æ— é¡µç  â†’ ç¬¬ä¸€é¡µï¼ˆåˆ†ç±»ç¬¬ä¸€é¡µ / æ ‡ç­¾ç¬¬ä¸€é¡µï¼‰
        href = '/' + base;
      }

      // è®¾ç½®è¿”å›žæŒ‰é’®
      backLink.href = href;
      backText.textContent = ' ' + '#{_p("post.back_to_current_page")}';

      // ðŸ§© è°ƒè¯•è¾“å‡ºï¼Œå¯æŸ¥çœ‹å®žé™…è¿”å›žè·¯å¾„
      console.log('[Butterfly] è¿”å›žè·¯å¾„:', href);

    } else {
      // âœ… æ²¡æœ‰ from å‚æ•° â†’ è¿”å›žé¦–é¡µ
      backLink.href = '/';
      backText.textContent = ' ' + '#{_p("post.back_to_home")}';
    }
  })();


script.
  (function() {
    function checkTitleScroll() {
      const title = document.querySelector('.nav-page-title .site-name:first-child');
      const container = document.querySelector('.nav-page-title');
      if (!title || !container) return;
      // è§¦å‘å¸ƒå±€è®¡ç®—
      title.offsetWidth;

      if (title.scrollWidth > container.clientWidth) {
        title.classList.add('scroll-enabled');
      } else {
        title.classList.remove('scroll-enabled');
      }
    }

    window.addEventListener('load', () => {
      setTimeout(checkTitleScroll, 300);

      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => setTimeout(checkTitleScroll, 100));
      }
    });

    if (document.fonts) {
      document.fonts.addEventListener('loadingdone', checkTitleScroll);
    }

    window.addEventListener('resize', checkTitleScroll);
  })();