// ============================================================
// Butterfly 主题导航栏 nav.pug
// 支持动态返回 分类 / 标签 / 归档 / 首页分页 来源（精准页码返回）
// ============================================================

nav#nav
  span#blog-info
    // ========================
    // 非文章页：显示站点标题
    // ========================
    if globalPageType !== 'post'
      a.nav-site-title(href=url_for('/'))
        if theme.nav.logo
          img.site-icon(src=url_for(theme.nav.logo) alt='Logo')
        if theme.nav.display_title
          span.site-name=config.title

    // ========================
    // 文章页：显示文章标题与返回按钮
    // ========================
    if globalPageType === 'post' && theme.nav.display_post_title
      // 初始为主页链接，稍后 JS 动态修改为来源路径
      a.nav-page-title#nav-back(href=url_for('/'))
        span.site-name= page.title || config.title
        span.site-name
          i.fa-solid.fa-circle-arrow-left
          // 默认显示“返回首页”，JS 动态切换
          span#nav-back-text= ' ' + _p('post.back_to_home')

  // ========================
  // 菜单区域
  // ========================
  #menus
    if theme.menu
      != partial('includes/header/menu_item', {}, {cache: true})
      #toggle-menu
        span.site-page
          i.fas.fa-bars.fa-fw

  // ========================
  // 搜索按钮
  // ========================
  if theme.search.use
    #search-button
      span.site-page.social-icon.search
        i.fas.fa-search.fa-fw
        //- span= ' ' + _p('search.title')


// ============================================================
// ✅ JS：动态判断来源 → 精确返回到所在页（含 page/2/#content-inner）
// ============================================================
script.
  (function() {
    var backLink = document.getElementById('nav-back');
    var backText = document.getElementById('nav-back-text');
    if (!backLink || !backText) return;

    // 读取 URL 参数
    var params = new URLSearchParams(window.location.search);
    var from = params.get('from');     // 来源：page / categories/... / tags/... / archives
    var pageNum = params.get('page');  // 当前页码

    if (from) {
      // ✅ 解码中文路径并规范化（去除首尾斜杠）
      var normalized = decodeURIComponent(from).replace(/^\/|\/$/g, '');
      var isHomePagePager = (normalized === 'page'); // 是否为首页分页
      var href = '/';

      // ✅ 有分页号时
      if (pageNum && /^\d+$/.test(pageNum)) {
        if (isHomePagePager) {
          // 首页分页 → /page/2/#content-inner
          href = (pageNum === '1')
            ? '/'
            : '/page/' + pageNum + '/#content-inner';
        } else {
          // 分类 / 标签 / 归档分页
          href = (pageNum === '1')
            ? '/' + normalized + '/#content-inner'
            : '/' + normalized + '/page/' + pageNum + '/#content-inner';
        }
      } else {
        // ✅ 无分页号 → 第一页
        href = isHomePagePager ? '/' : '/' + normalized + '/#content-inner';
      }

      // ✅ 更新返回按钮
      backLink.href = href;
      backText.textContent = ' ' + '#{_p("post.back_to_current_page")}';

      console.log('[Butterfly] 返回路径:', href);
    } else {
      // ✅ 没有 from 参数 → 返回首页
      backLink.href = '/';
      backText.textContent = ' ' + '#{_p("post.back_to_home")}';
    }
  })();
