// ============================================================
// 文章列表排序组件（适用于分类页、标签页、归档页）
// 自动识别来源路径 (fromPath) 和当前分页页码 (currentPage)
// ============================================================

mixin articleSort(posts, opts)
  -
    // 1️⃣ 获取传入参数（来源路径和当前页码）
    const fromPath = (opts && opts.fromPath) ? opts.fromPath : ''
    const currentPage = (opts && opts.currentPage) ? opts.currentPage : ''

  .article-sort
    - let year
    - posts.forEach(article => {
      // 2️⃣ 获取文章所属年份，用于时间分组
      - const tempYear = date(article.date, 'YYYY')

      // 3️⃣ 判断文章是否有封面，用于样式区分
      - const noCoverClass = article.cover === false || !theme.cover.archives_enable ? 'no-article-cover' : ''
      - const title = article.title || _p('no_title')

      // 4️⃣ 生成文章基础链接
      - const baseLink = url_for(article.path)

      // 5️⃣ 拼接带来源参数的链接（⚠️ 使用字符串拼接，Pug 不支持模板字符串）
      - const hasFromInfo = fromPath && currentPage
      - const href = hasFromInfo ? (baseLink + '?from=' + fromPath + '&page=' + currentPage) : baseLink

      // 6️⃣ 年份标签（仅在年份变化时输出）
      if tempYear !== year
        - year = tempYear
        .article-sort-item.year= year

      // 7️⃣ 渲染文章条目
      .article-sort-item(class=noCoverClass)
        if article.cover && theme.cover.archives_enable
          a.article-sort-item-img(href=href title=title)
            if article.cover_type === 'img'
              img(
                src=url_for(article.cover)
                alt=title
                onerror=`this.onerror=null;this.src='${url_for(theme.error_img.post_page)}'`
              )
            else
              div(style=`background: ${article.cover}`)
        .article-sort-item-info
          .article-sort-item-time
            i.far.fa-calendar-alt
            time.post-meta-date-created(
              datetime=date_xml(article.date)
              title=_p('post.created') + ' ' + full_date(article.date)
            )= date(article.date, config.date_format)

          // 8️⃣ 带来源参数的文章标题链接
          a.article-sort-item-title(href=href title=title)= title
    - })
